var Game=Class.extend({init:function(e){if(e===undefined||e===null){e=new GameObjManager}var t=e.WindowWidth;var n=e.WindowHeight;var r='<canvas id="game-field" width="'+t+'" height="'+n+'">To play this game, you need a more <a href="http://lmgtfy.com/?q=Modern+Browser">Modern Browser</a></canvas>';$("#loader").hide();$("#gameHolder").empty();$(r).appendTo("#gameHolder");var i=$("#game-field");var s=i.get(0).getContext("2d");s.fillStyle="rgb(0,0,0)";this.context=s;this.canvasX=0;this.canvasY=0;this.canvasWidth=t;this.canvasHeight=n;this.canvasMiddle=t/2;this.canvasVMiddle=n/2;this.backBuffer=document.createElement("canvas");this.backBuffer.width=this.canvasWidth;this.backBuffer.height=this.canvasHeight;this.backBufferContext=this.backBuffer.getContext("2d");this.GameObjManager=e;this.SetDefaults()},ButtonClick:function(e,t){var n=this.GameObjManager.Buttons;var r=false;var i,s;var o=this.canvasX;var u=this.canvasY;if(e>o){i=e-o}else{i=o-e}if(t>u){s=t-u}else{s=u-t}for(var a in n){var f=n[a].x,l=n[a].x+n[a].width;var c=n[a].y,h=n[a].y+n[a].height;if(l>=i&&f<=i&&h>=s&&c<=s){r=n[a]}}return r},ToggleButton:function(e){var t=this.GameObjManager;switch(e.id){case"music":var n=t.GetOption("audio")==="true";t.SetOption("audio",!n);!n===true?this.PlayAudio("audio-theme",t):this.StopAudio("audio-theme",t);this.DrawButtons(this.context,false,t);break}},Shoot:function(){if(this.Shooting===true){var e=this.GameObjManager;this.Shots.push(e.NewShot())}},EnemyShoot:function(e,t){if(t.frequency!==undefined&&t.frequency!==null){if(this.EnemyShooting===false&&this.EnemyShots.length<t.frequency){this.EnemyShots.push(e.NewEnemyShot(t))}}},SetDefaults:function(){this.LevelTitle="";this.EOL=false;this.ScrollPosition=this.canvasWidth+1;this.Backgrounds=[];this.Moving=false;this.MoveLeft=false;this.MoveRight=false;this.MoveUp=false;this.MoveDown=false;this.Shooting=false;this.Shots=[];this.PlayerHit=false;this.PlayerInvertCount=0;this.Enemies=[];this.Fighting=false;this.EnemyShots=[];this.EnemyShooting=false},PlayAudio:function(e,t){var n=t.GetOption("audio")==="true";if(n===true){switch(e){case"audio-theme":t.AudioTheme.play();break}}},StopAudio:function(e,t){t.AudioTheme.pause()},DrawImage:function(e,t,n,r,i,s){try{if(t.complete===true){e.drawImage(t,n,r,i,s)}else{(function(t,n,r){t.onload=function(){e.drawImage(t,n,r,i,s)}})(t,n,r)}}catch(o){}},DrawGrayscale:function(e){var t=this.canvasWidth;var n=this.canvasHeight;var r=e.getImageData(0,0,t,n);var i=r.data;for(var s=0;s<i.length;s+=4){var o=.34*i[s]+.5*i[s+1]+.16*i[s+2];i[s]=o;i[s+1]=o;i[s+2]=o}e.putImageData(r,0,0,t,n)},DestroyCanvas:function(e,t,n){e.clearRect(0,0,this.canvasWidth,this.canvasHeight);t.clearRect(0,0,this.canvasWidth,this.canvasHeight);var r=$("#nameInput").hide();var i=$("#tardisFade");i.hide()},DrawButtons:function(e,t,n){var r=new Buttons;this.GameObjManager.Buttons=r.Draw(e,t,n,this.canvasX,this.canvasWidth,this.canvasHeight,this.canvasMiddle,this.canvasVMiddle,this.LevelTitle,this.DrawImage)},DrawHeader:function(e,t,n){var r=n.Group;e.fillStyle="rgba(255,255,255,.9)";e.fillRect(0,0,t,25);switch(r){case"index":break;case"playerSelect":var i="Create or Select Player";e.font=n.DefaultFont;e.fillStyle="rgb(0,0,0)";var s=e.measureText(i);e.fillText(i,this.canvasX-s.width/1.7,20);break;case"levelSelect":e.font=n.DefaultFont;e.fillStyle="rgb(0,0,0)";i="Select Level";s=e.measureText(i);e.fillText(i,this.canvasX-s.width,20);break;case"level":case"eol":e.font=n.DefaultFont;e.fillStyle="rgb(0,0,0)";if(r==="level"){i="Level: "+ATD.Level;s=e.measureText(i);e.fillText(i,this.canvasWidth/2,20)}var o="Health: ";s=e.measureText(o);e.fillText(o,50,20);var u=n.CurrentPlayer.health;if(u>=100){e.fillStyle="rgba(0,255,0,.8)"}else if(u>50&&u<100){e.fillStyle="rgba(255,255,0,.8)"}else{e.fillStyle="rgba(255,0,0,.8)"}e.fillRect(s.width,6,u,15);e.strokeStyle="rgba(0,0,0,1)";e.strokeRect(s.width,6,200,15)}},DrawFloor:function(e,t,n,r){e.fillStyle="rgba(0,255,0,.8)";e.fillRect(0,r.WindowHeight-25,t,25)},DrawBackground:function(e,t){var n=this.Backgrounds;var r=n.length;var i=t.Level.LevelWidth;var s=new Image;var o=new Image;var u=new Image;for(var a in n){var f=n[a];s.src=f.imgSrc0;o.src=f.imgSrc1;u.src=f.imgSrc2;var l=f.x0;var c=f.x1;var h=f.x2;if(this.MoveLeft===true&&this.Moving===true&&t.CurrentPlayer.sprite.x+t.CurrentPlayer.sprite.width>=this.canvasMiddle-100){l-=6;c-=9;h-=12}if(this.MoveRight===true&&l<f.startX0&&t.CurrentPlayer.sprite.x<=60){l+=6;c+=9;h+=12}this.DrawImage(e,s,l,f.y,f.width0,f.height);this.DrawImage(e,o,c,f.y,f.width1,f.height);this.DrawImage(e,u,h,f.y,f.width2,f.height);f.x0=l;f.x1=c;f.x2=h}this.ScrollPosition=n[0].x0-i},DrawEol:function(e,t,n){e.fillStyle="rgb(0,0,0)";t.fillStyle="rgb(0,0,0)";if(n===true){e.fillStyle="rgba(0,0,0,.5)";t.fillStyle="rgba(0,0,0,.5)"}e.fillRect(0,0,this.canvasWidth,this.canvasHeight);t.fillRect(0,0,this.canvasWidth,this.canvasHeight)},DrawEnemies:function(e,t){var n=this.Enemies;var r=this.canvasWidth;var i=[];var s=function(){ATD.Level+=1;this.DrawEndOfLevel(t.Level)};var o=function(){g.hide();ATD.MainLoopInterval=setInterval(function(){ATD.CurrentGame.DrawLevel(ATD.CurrentGame.GameObjManager.Level)}.bind(this),ATD.MilleInterval)};for(var u in n){var a=new Image;var f=n[u];var l=f.x;var c=f.y;var h=f.width+l;if(f.ObjType==="enemy"||f.ObjType==="boss"){if(f.hit===false){a.src=f.imgSrc}else{a.src=f.imgSrcInvert}if(this.MoveLeft===true&&this.Moving===true&&t.CurrentPlayer.sprite.x+t.CurrentPlayer.sprite.width>=this.canvasMiddle-100){l-=12;this.Moving=true}if(h<r){this.Moving=false}if(l<r){f.fighting=true;this.Fighting=true}if(this.MoveRight===true&&l<f.startX&&t.CurrentPlayer.sprite.x<=60){l+=12;this.Moving=true;if(l>r){f.fighting=false;this.Fighting=false}}if(f.ObjType==="boss"){var p=25;var d=this.canvasHeight-25;var v=c+f.height;if(c>=p&&f.moveUp===true){c-=8;f.moveUp=true;f.moveDown=false}else{f.moveUp=false;f.moveDown=true}if(c<=p||c>=p&&v<=d&&f.moveDown===true){c+=8;f.moveUp=false;f.moveDown=true}else{f.moveUp=true;f.moveDown=false}}if(f.hitCount===6){f.hit=false;f.hitCount=0}f.hitCount++}else{a.src=f.imgSrc;if(this.MoveLeft===true&&this.Fighting===false&&this.EOL===false&&t.CurrentPlayer.sprite.x+t.CurrentPlayer.sprite.width>=this.canvasMiddle-100){l-=12;this.Moving=true}if(this.MoveRight===true&&l<f.startX&&t.CurrentPlayer.sprite.x<=60){l+=12;this.Moving=true}if(f.type==="tardis"){if(h<r){this.EOL=true}}if(f.type==="doctor"&&f.saved===true){l+=12;if(h>=r-100){i.push(f)}}var m=this.DetectPowerUpCollision(l,c,f.width,f.height,f.health,f.type);if(m===true){switch(f.type){case"tardis":i.push(f);setTimeout(s.bind(this),ATD.MilleInterval);break;case"doctor":clearInterval(ATD.MainLoopInterval);ATD.MainLoopInterval=null;f.saved=true;var g=$("#speech");g.html(f.message);var y=g.width();var b=g.outerHeight(true);g.width(g.outerWidth()/2);g.css({left:f.x-40,top:f.y-b+15});g.show();setTimeout(o.bind(this),f.speechTime);break;default:i.push(f);break}}}this.DrawImage(e,a,l,c,f.width,f.height);f.x=l;f.y=c;this.Enemies[u]=f}for(var u in i){this.Enemies.splice($.inArray(i[u],this.Enemies),1)}},DrawPlayer:function(e,t){var n=t.CurrentPlayer;var r=new Image;if(this.PlayerHit===false){r.src=n.sprite.imgSrc}else{r.src=n.sprite.imgSrcInvert}var i=n.sprite.x;if(this.MoveLeft===true&&i+n.sprite.width<=this.canvasMiddle-100){i+=12;this.Moving=true}if(this.MoveLeft===true&&this.EOL===true){i+=12;this.Moving=false}if(this.MoveRight===true&&i>=n.sprite.startX){i-=12;this.Moving=true}var s=n.sprite.y;if(this.MoveUp===true&&s>25){s-=8}if(this.MoveDown===true&&s<n.sprite.startY){s+=8}this.DrawImage(e,r,n.sprite.x,s,n.sprite.width,n.sprite.height);if(this.PlayerInvertCount===6){this.PlayerHit=false;this.PlayerInvertCount=0}this.PlayerInvertCount++;t.CurrentPlayer.sprite.x=i;t.CurrentPlayer.sprite.y=s},DrawShooting:function(e,t){var n=this.Shots;if(this.Shooting===true){this.Shoot()}var r=[];for(var i in n){e.fillStyle=n[i].fillStyle;e.fillRect(n[i].x,n[i].y,n[i].width,n[i].height);var s=i-1;if(s!==-1){if(n[s].x-n[i].speed>n[i].x+n[i].width){n[i].x+=25}else{r.push(n[i])}}else{n[i].x+=25}var o=this.DetectCollision(n[i].x,n[i].y,n[i].width,n[i].height,true,n[i].damage);if(n[i].x>=this.canvasMiddle*2||o===true){r.push(n[i])}}for(var u in r){this.Shots.splice($.inArray(r[u],this.Shots),1)}},DrawFight:function(e,t){if(this.Fighting===true){var n=this.Enemies;for(var r in n){var i=n[r];if(i.fighting===true){this.EnemyShoot(t,i);var s=this.EnemyShots;var o=[];for(var u in s){this.EnemyShooting=true;e.fillStyle=s[u].fillStyle;e.fillRect(s[u].x,s[u].y,s[u].width,s[u].height);var a=this.DetectCollision(s[u].x,s[u].y,s[u].width,s[u].height,false,s[u].damage);s[u].x-=i.shotspeed;if(s[u].x+s[u].width<=this.canvasX/10||a===true){o.push(s[u])}}for(var f in o){this.EnemyShots.splice($.inArray(o[f],this.EnemyShots),1)}this.EnemyShooting=false}}}},DetectCollision:function(e,t,n,r,i,s){var o=e;var u=e+n;var a=t;var f=t+r;if(i===true){var l=this.Enemies;var c=[];var h=false;for(var p in l){var d=l[p];if(d.ObjType==="enemy"||d.ObjType==="boss"){if(u>=d.x&&a>=d.y&&f<=d.y+d.height){d.health-=s;d.hit=true;if(d.health<=0){c.push(d)}h=true}}}for(var v in c){this.Fighting=false;if(this.MoveLeft===true||this.MoveRight===true){this.Moving=true}this.EnemyShots=[];this.Enemies.splice($.inArray(c[v],this.Enemies),1)}return h}else{var m=this.GameObjManager.CurrentPlayer;if(o<=m.sprite.x+m.sprite.width&&a>=m.sprite.y&&f<=m.sprite.y+m.sprite.height){this.PlayerHit=true;this.GameObjManager.CurrentPlayer.health-=s;return true}}return false},DetectPowerUpCollision:function(e,t,n,r,i,s){var o=this.GameObjManager;if(o.Group==="level"){var u=e;var a=t;var f=t+r;var l=o.CurrentPlayer;switch(s){case"health":if(u<=l.sprite.x+l.sprite.width&&(a<=l.sprite.y&&f>=l.sprite.y||a<=l.sprite.y+l.sprite.height&&f>=l.sprite.y+l.sprite.height||a>=l.sprite.y&&f<=l.sprite.y+l.sprite.height)){var c=o.CurrentPlayer.health;if(c<200){this.GameObjManager.CurrentPlayer.health+=i}return true}break;case"doctor":if(u<=l.sprite.x+l.sprite.width&&(a<=l.sprite.y&&f>=l.sprite.y||a<=l.sprite.y+l.sprite.height&&f>=l.sprite.y+l.sprite.height||a>=l.sprite.y&&f<=l.sprite.y+l.sprite.height)){return true}break;case"tardis":if(u<=l.sprite.x&&f>=l.sprite.y&&a<=l.sprite.y){this.MoveLeft=false;return true}break}return false}},ExplodeEnemy:function(e){},FadeTardis:function(e,t){ATD.Fading=true;var n=$("#tardisFade");var r=t.Group;switch(r){case"sol":n.css({left:t.CurrentPlayer.sprite.x-5,top:this.canvasHeight-307});n.fadeTo(1e3,.5).fadeTo(1e3,0).fadeTo(1e3,.8).fadeTo(1e3,0).fadeTo(1e3,1,function(){ATD.Fading=false}.bind(this));break;case"eol":n.css({left:t.CurrentPlayer.sprite.x-17,top:this.canvasHeight-307});n.fadeTo(10,1).fadeTo(1e3,.8).fadeTo(1e3,1).fadeTo(1e3,.5).fadeTo(1e3,1).fadeTo(1e3,0,function(){ATD.Fading=false}.bind(this));break}},DrawIndex:function(){var e=this.GameObjManager;e.Group="index";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);this.DrawButtons(n,false,e);this.PlayAudio("audio-theme",e);t.drawImage(this.backBuffer,0,0)},DrawCredits:function(){var e=this.GameObjManager;e.Group="credits";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);n.fillStyle="rgba(0,0,0,.7)";n.fillRect(10,35,this.canvasWidth-20,this.canvasHeight-45);this.DrawButtons(n,false,e);t.drawImage(this.backBuffer,0,0)},DrawPlayerSelect:function(){var e=this.GameObjManager;e.Group="playerSelect";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);n.fillStyle="rgba(0,0,0,.5)";n.fillRect(this.canvasX+90,this.canvasY+30,550,this.canvasHeight);this.DrawButtons(n,false,e);var i=$("#nameInput");i.css({top:this.canvasY+40,left:this.canvasX+100});i.show();$("#name").val("");$("#name").focus();t.drawImage(this.backBuffer,0,0)},DrawLevelSelect:function(){var e=this.GameObjManager;e.Group="levelSelect";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);this.DrawButtons(n,false,e);t.drawImage(this.backBuffer,0,0)},DrawLevelStart:function(e){var t=this.GameObjManager;t.Group="sol";t.Level=e;t.CurrentPlayer.sprite.x=60;var n=this.context;var r=this.backBufferContext;this.DestroyCanvas(n,r,true);this.LevelTitle=e.LevelTitle;this.DrawBackground(r,t);this.DrawFloor(r,this.canvasWidth,null,t);this.FadeTardis(r,t);this.DrawEnemies(r,t);this.DrawEol(n,r,true);this.DrawHeader(r,this.canvasWidth,t);this.DrawButtons(r,false,t);n.drawImage(this.backBuffer,0,0);if(e.Grayscale===true){this.DrawGrayscale(n)}},DrawLevel:function(e){var t=this.GameObjManager;t.Group="level";t.Level=e;var n=this.context;var r=this.backBufferContext;this.DestroyCanvas(n,r,false);if(t.CurrentPlayer.health>0){this.DrawBackground(r,t);this.DrawPlayer(r,t);this.DrawEnemies(r,t);this.DrawHeader(r,this.canvasWidth,t);this.DrawButtons(r,false,t);this.DrawFloor(r,this.canvasWidth,null,t);this.DrawShooting(r,t);this.DrawFight(r,t);n.drawImage(this.backBuffer,0,0);if(e.Grayscale===true){this.DrawGrayscale(n)}}else{this.MoveLeft=false;ATD.Level=e.LevelNumber;this.DrawEndOfLevel(e)}},DrawEndOfLevel:function(e){clearInterval(ATD.MainLoopInterval);ATD.MainLoopInterval=null;var t=this.GameObjManager;t.Group="eol";t.Level=e;var n=this.context;var r=this.backBufferContext;this.DestroyCanvas(n,r,true);if(t.CurrentPlayer.health>0){$("#tardisFade").css({left:t.CurrentPlayer.sprite.x-17,top:this.canvasHeight-307}).show()}this.DrawBackground(r,t);this.DrawFloor(r,this.canvasWidth,null,t);this.DrawEol(n,r,true);this.DrawHeader(r,this.canvasWidth,t);this.DrawButtons(r,false,t);this.SetDefaults();n.drawImage(this.backBuffer,0,0);if(e.Grayscale===true){this.DrawGrayscale(n)}}})