var Game=Class.extend({init:function(e){if(e===undefined||e===null){e=new GameObjManager}var t=e.WindowWidth;var n=e.WindowHeight;var r='<canvas id="game-field" width="'+t+'" height="'+n+'">To play this game, you need a more <a href="http://lmgtfy.com/?q=Modern+Browser">Modern Browser</a></canvas>';$("#loader").hide();$("#gameHolder").empty();$(r).appendTo("#gameHolder");var i=$("#game-field");var s=i.get(0).getContext("2d");s.fillStyle="rgb(0,0,0)";this.context=s;this.canvasX=0;this.canvasY=0;this.canvasWidth=t;this.canvasHeight=n;this.canvasMiddle=t/2;this.canvasVMiddle=n/2;this.backBuffer=document.createElement("canvas");this.backBuffer.width=this.canvasWidth;this.backBuffer.height=this.canvasHeight;this.backBufferContext=this.backBuffer.getContext("2d");this.GameObjManager=e;this.SetDefaults()},ButtonClick:function(e,t){var n=this.GameObjManager.Buttons;var r=false;var i,s;var o=this.canvasX;var u=this.canvasY;if(e>o){i=e-o}else{i=o-e}if(t>u){s=t-u}else{s=u-t}for(var a in n){var f=n[a].x,l=n[a].x+n[a].width;var c=n[a].y,h=n[a].y+n[a].height;if(l>=i&&f<=i&&h>=s&&c<=s){r=n[a]}}return r},ToggleButton:function(e){var t=this.GameObjManager;switch(e.id){case"music":var n=t.GetOption("audio")==="true";t.SetOption("audio",!n);!n===true?this.PlayAudio("audio-theme",t):this.StopAudio("audio-theme",t);this.DrawButtons(this.context,false,t);break}},Shoot:function(){if(this.Shooting===true){var e=this.GameObjManager;this.Shots.push(e.NewShot())}},EnemyShoot:function(e,t){if(t.frequency!==undefined&&t.frequency!==null){if(this.EnemyShooting===false&&this.EnemyShots.length<t.frequency){this.EnemyShots.push(e.NewEnemyShot(t,this.canvasWidth-200))}}},SetDefaults:function(){this.LevelTitle="";this.ScrollPosition=this.canvasWidth+1;this.Backgrounds=[];this.MoveLeft=false;this.MoveRight=false;this.MoveUp=false;this.MoveDown=false;this.Shooting=false;this.Shots=[];this.PlayerHit=false;this.PlayerInvertCount=0;this.Enemies=[];this.Fighting=false;this.EnemyShots=[];this.EnemyShooting=false},PlayAudio:function(e,t){var n=t.GetOption("audio")==="true";if(n===true){switch(e){case"audio-theme":t.AudioTheme.play();break}}},StopAudio:function(e,t){t.AudioTheme.pause()},DrawImage:function(e,t,n,r,i,s){try{var o=false;if(t.complete===true){e.drawImage(t,n,r,i,s);if(o===true){var u=e.getImageData(n,r,i,s);var a=u.data;for(var f=0;f<a.length;f+=4){var l=.34*a[f]+.5*a[f+1]+.16*a[f+2];a[f]=l;a[f+1]=l;a[f+2]=l}e.putImageData(u,n,r,i,s)}}else{(function(t,n,r){t.onload=function(){e.drawImage(t,n,r,i,s)}})(t,n,r)}}catch(c){}},DestroyCanvas:function(e,t,n){e.clearRect(0,0,this.canvasWidth,this.canvasHeight);t.clearRect(0,0,this.canvasWidth,this.canvasHeight);var r=$("#nameInput").hide()},DrawButtons:function(e,t,n){var r=new Buttons;var i=[];if(!t){switch(n.Group){case"index":var s=r.GetButtons(n,false);var o=this.canvasX+this.canvasWidth;var u=this.canvasHeight;var a=u-210;for(var f in s){var l=s[f];if(l.imgSrc!==undefined&&l.imgSrc!==null){if(l.id==="player"){l.x=60;l.y=u-175;this.DrawImageButton(e,l,false)}if(l.id==="title"){l.x=this.canvasMiddle-l.width/2;l.y=55;this.DrawImageButton(e,l,true)}}else{l.x=o-l.width-20;l.y=a;this.DrawTextButton(e,l);a+=70}i.push(l)}break;case"credits":var c=new LabelButton("credits",n);var a=35;c.text="• Created/Developed/Designed By: Nicklas DeMayo | Url: ";var h=e.measureText(c.text);c.width=h.width;c.x=20;c.y=a;this.DrawTextButton(e,c);i[0]=new LinkButton("credits",n);i[0].text="http://www.csbctech.com";h=e.measureText(i[0].text);i[0].width=h.width;i[0].x=c.x+c.width;i[0].y=c.y;this.DrawTextButton(e,i[0]);c.text="• Dalek Character Graphic By: LBondo | Url: ";h=e.measureText(c.text);c.width=h.width;c.x=20;c.y+=a+10;this.DrawTextButton(e,c);i[1]=new LinkButton("credits",n);i[1].text="http://lbondo.deviantart.com/";h=e.measureText(i[1].text);i[1].width=h.width;i[1].x=c.x+c.width;i[1].y=c.y;this.DrawTextButton(e,i[1]);c.text="• T.A.R.D.I.S. Graphic By: Copiously Geeky | Url: ";h=e.measureText(c.text);c.width=h.width;c.x=20;c.y+=a+10;this.DrawTextButton(e,c);i[2]=new LinkButton("credits",n);i[2].text="http://copiouslygeeky.com/";h=e.measureText(i[2].text);i[2].width=h.width;i[2].x=c.x+c.width;i[2].y=c.y;this.DrawTextButton(e,i[2]);break;case"playerSelect":var p=r.GetPlayerButtons(n);for(var f in p){l=p[f];if(l.id==="submitName"){l.x=420;l.y=68;this.DrawTextButton(e,l)}else{this.DrawTextButton(e,l)}i.push(l)}break;case"levelSelect":var d=r.GetLevelButtons(n,44,n.CurrentPlayer.level);for(var f in d){l=d[f];if(l.locked===false){this.DrawTextButton(e,l)}else{this.DrawImageButton(e,l)}i.push(l)}break;case"sol":var v=r.GetButtons(n,false);for(var f in v){l=v[f];l.x=this.canvasMiddle-l.width/2;l.y=this.canvasVMiddle-l.height;l.text=this.LevelTitle;this.DrawTextButton(e,l);i.push(l)};case"eol":s=r.GetButtons(n,false);var m=n.CurrentPlayer.health;for(var f in s){l=s[f];switch(l.id){case"levelStatus":l.x=this.canvasMiddle-l.width/2;l.y=35;if(m===0){l.text="You Were Exterminated!"}break;case"nextLevel":l.x=this.canvasMiddle-l.width/2;l.y=35+l.height+10;if(m===0){l.text="Retry";l.level=new Levels(ATD.Level,n.WindowHeight,n.WindowWidth);n.CurrentPlayer.health=200;n.SavePlayer(n.CurrentPlayer)}else{ATD.Level+=1;l.level=new Levels(ATD.Level,n.WindowHeight,n.WindowWidth);if(ATD.Level>n.CurrentPlayer.level){n.CurrentPlayer.level=ATD.Level;n.SavePlayer(n.CurrentPlayer)}}break}this.DrawTextButton(e,l);i.push(l)}break}}var g=r.GetButtons(n,true);for(var f in g){var y=g[f];var b=new Image;switch(y.id){case"music":var w=n.GetOption("audio")==="true";if(w===true){b.src=y.imgSrcOn}else{b.src=y.imgSrcOff}y.x=this.canvasWidth-y.width;break;case"home":if(n.Group!=="index"){b.src=y.imgSrc;y.x=this.canvasWidth-y.width*2}break}y.y=0;this.DrawImage(e,b,y.x,0,y.width,y.height);i.push(y)}this.GameObjManager.Buttons=i},DrawTextButton:function(e,t){e.fillStyle=t.color;e.fillRect(t.x,t.y,t.width,t.height);e.fillStyle=t.textColor;e.textAlign="center";e.font=t.font;var n=e.measureText(t.text);e.fillText(t.text,t.x+t.width/2,t.y+t.height/1.7)},DrawImageButton:function(e,t,n){if(n===undefined||n===null){n=true}if(n===true){e.fillStyle=t.color;e.fillRect(t.x,t.y,t.width,t.height)}var r=new Image;r.src=t.imgSrc;this.DrawImage(e,r,t.x,t.y,t.width,t.height)},DrawHeader:function(e,t,n){var r=n.Group;e.fillStyle="rgba(255,255,255,.9)";e.fillRect(0,0,t,25);switch(r){case"index":break;case"playerSelect":var i="Create or Select Player";e.font=n.DefaultFont;e.fillStyle="rgb(0,0,0)";var s=e.measureText(i);e.fillText(i,this.canvasX-s.width/1.7,20);break;case"levelSelect":e.font=n.DefaultFont;e.fillStyle="rgb(0,0,0)";i="Select Level";s=e.measureText(i);e.fillText(i,this.canvasX-s.width,20);break;case"level":case"eol":e.font=n.DefaultFont;e.fillStyle="rgb(0,0,0)";i="Level: "+ATD.Level;s=e.measureText(i);e.fillText(i,this.canvasWidth/2,20);var o="Health: ";s=e.measureText(o);e.fillText(o,50,20);var u=n.CurrentPlayer.health;if(u>=100){e.fillStyle="rgba(0,255,0,.8)"}else if(u>50&&u<100){e.fillStyle="rgba(255,255,0,.8)"}else{e.fillStyle="rgba(255,0,0,.8)"}e.fillRect(s.width,6,u,15);e.strokeRect(s.width,6,u,15)}},DrawFloor:function(e,t,n,r){e.fillStyle="rgba(0,255,0,.8)";e.fillRect(0,r.WindowHeight-25,t,25)},DrawBackground:function(e,t){var n=this.Backgrounds;var r=n.length;var i=n[r-1].width0;var s=new Image;var o=new Image;var u=new Image;for(var a in n){var f=n[a];s.src=f.imgSrc0;o.src=f.imgSrc1;u.src=f.imgSrc2;var l=f.x0;var c=f.x1;var h=f.x2;if(this.MoveLeft===true&&this.Fighting===false){l-=6;c-=9;h-=12}if(this.MoveRight===true&&l<f.startX0){l+=6;c+=9;h+=12}this.DrawImage(e,s,l,f.y,f.width0,f.height);this.DrawImage(e,o,c,f.y,f.width1,f.height);this.DrawImage(e,u,h,f.y,f.width2,f.height);f.x0=l;f.x1=c;f.x2=h}this.ScrollPosition=n[0].x0+i},DrawEol:function(e,t,n){e.fillStyle="rgb(0,0,0)";t.fillStyle="rgb(0,0,0)";if(n===true){e.fillStyle="rgba(0,0,0,.5)";t.fillStyle="rgba(0,0,0,.5)"}e.fillRect(0,0,this.canvasWidth,this.canvasHeight);t.fillRect(0,0,this.canvasWidth,this.canvasHeight)},DrawEnemies:function(e,t){var n=this.Enemies;var r=this.canvasWidth/2;var i=[];for(var s in n){var o=new Image;var u=n[s];var a=u.x;if(u.ObjType==="enemy"){if(u.hit===false){o.src=u.imgSrc}else{o.src=u.imgSrcInvert}var f=u.width+(a-r);if(this.MoveLeft===true&&this.Fighting===false){if(f>r){a-=8}else{u.fighting=true;this.Fighting=true}}if(this.MoveRight===true&&a<u.startX){a+=8;if(a>320){u.fighting=false;this.Fighting=false}}if(u.hitCount===6){u.hit=false;u.hitCount=0}u.hitCount++}else{o.src=u.imgSrc;if(this.MoveLeft===true&&this.Fighting===false){a-=8}if(this.MoveRight===true&&a<u.startX){a+=8}var l=this.DetectPowerUpCollision(a,u.y,u.width,u.height,u.health);if(l===true){i.push(u)}}this.DrawImage(e,o,a,u.y,u.width,u.height);u.x=a;this.Enemies[s]=u}for(var s in i){this.Enemies.splice($.inArray(i[s],this.Enemies),1)}},DrawPlayer:function(e,t){var n=t.CurrentPlayer;var r=new Image;if(this.PlayerHit===false){r.src=n.sprite.imgSrc}else{r.src=n.sprite.imgSrcInvert}var i=n.sprite.y;if(this.MoveUp===true&&i>25){i-=8}if(this.MoveDown===true&&i<n.sprite.startY){i+=8}this.DrawImage(e,r,n.sprite.x,i,n.sprite.width,n.sprite.height);if(this.PlayerInvertCount===6){this.PlayerHit=false;this.PlayerInvertCount=0}this.PlayerInvertCount++;t.CurrentPlayer.sprite.y=i},DrawShooting:function(e,t){var n=this.Shots;if(this.Shooting===true){this.Shoot()}var r=[];for(var i in n){e.fillStyle=n[i].fillStyle;e.fillRect(n[i].x,n[i].y,n[i].width,n[i].height);n[i].x+=25;var s=this.DetectCollision(n[i].x,n[i].y,n[i].width,n[i].height,true,n[i].damage);if(n[i].x>=this.canvasMiddle*2||s===true){r.push(n[i])}}for(var o in r){this.Shots.splice($.inArray(r[o],this.Shots),1)}},DrawFight:function(e,t){if(this.Fighting===true){var n=this.Enemies;for(var r in n){var i=n[r];if(i.fighting===true){this.EnemyShoot(t,i);var s=this.EnemyShots;var o=[];for(var u in s){this.EnemyShooting=true;e.fillStyle=s[u].fillStyle;e.fillRect(s[u].x,s[u].y,s[u].width,s[u].height);var a=this.DetectCollision(s[u].x,s[u].y,s[u].width,s[u].height,false,s[u].damage);s[u].x-=i.shotspeed;if(s[u].x+s[u].width<=this.canvasX/10||a===true){o.push(s[u])}}for(var f in o){this.EnemyShots.splice($.inArray(o[f],this.EnemyShots),1)}this.EnemyShooting=false}}}},DetectCollision:function(e,t,n,r,i,s){var o=e;var u=e+n;var a=t;var f=t+r;if(i===true){var l=this.Enemies;var c=[];var h=false;for(var p in l){var d=l[p];if(d.ObjType==="enemy"){if(u>=d.x&&a>=d.y&&f<=d.y+d.height){d.health-=s;d.hit=true;if(d.health<=0){c.push(d)}h=true}}}for(var v in c){this.Fighting=false;this.EnemyShots=[];this.Enemies.splice($.inArray(c[v],this.Enemies),1)}return h}else{var m=this.GameObjManager.CurrentPlayer;if(o<=m.sprite.x+m.sprite.width&&a>=m.sprite.y&&f<=m.sprite.y+m.sprite.height){this.PlayerHit=true;this.GameObjManager.CurrentPlayer.health-=s;return true}}return false},DetectPowerUpCollision:function(e,t,n,r,i){var s=e;var o=t;var u=t+r;var a=this.GameObjManager.CurrentPlayer;if(s<=a.sprite.x+a.sprite.width&&(o<=a.sprite.y&&u>=a.sprite.y||o<=a.sprite.y+a.sprite.height&&u>=a.sprite.y+a.sprite.height||o>=a.sprite.y&&u<=a.sprite.y+a.sprite.height)){this.GameObjManager.CurrentPlayer.health+=i;return true}return false},ExplodeEnemy:function(e){},DrawIndex:function(){var e=this.GameObjManager;e.Group="index";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);this.DrawButtons(n,false,e);this.PlayAudio("audio-theme",e);t.drawImage(this.backBuffer,0,0)},DrawCredits:function(){var e=this.GameObjManager;e.Group="credits";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);n.fillStyle="rgba(0,0,0,.7)";n.fillRect(10,35,this.canvasWidth-20,this.canvasHeight-45);this.DrawButtons(n,false,e);t.drawImage(this.backBuffer,0,0)},DrawPlayerSelect:function(){var e=this.GameObjManager;e.Group="playerSelect";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);n.fillStyle="rgba(0,0,0,.7)";n.fillRect(this.canvasX+90,this.canvasY+30,550,this.canvasHeight);this.DrawButtons(n,false,e);var i=$("#nameInput");i.css({top:this.canvasY+40,left:this.canvasX+100});i.show();$("#name").val("");$("#name").focus();t.drawImage(this.backBuffer,0,0)},DrawLevelSelect:function(){var e=this.GameObjManager;e.Group="levelSelect";var t=this.context;var n=this.backBufferContext;this.DestroyCanvas(t,n,false);var r=new Image;r.src="images/bg.jpg";this.DrawImage(n,r,0,0,this.canvasWidth,this.canvasHeight);this.DrawHeader(n,this.canvasWidth,e);this.DrawButtons(n,false,e);t.drawImage(this.backBuffer,0,0)},DrawLevelStart:function(e){var t=this.GameObjManager;t.Group="sol";var n=this.context;var r=this.backBufferContext;this.DestroyCanvas(n,r,true);this.LevelTitle=e.LevelTitle;this.DrawBackground(r,t);this.DrawFloor(r,this.canvasWidth,null,t);this.DrawPlayer(r,t);this.DrawEol(n,r,true);this.DrawHeader(r,this.canvasWidth,t);this.DrawButtons(r,false,t);n.drawImage(this.backBuffer,0,0)},DrawLevel:function(e){var t=this.GameObjManager;t.Group="level";var n=this.context;var r=this.backBufferContext;this.DestroyCanvas(n,r,false);var i=this.ScrollPosition;var s=this.canvasWidth;if(i>s&&t.CurrentPlayer.health>0){this.DrawBackground(r,t);this.DrawEnemies(r,t);this.DrawHeader(r,this.canvasWidth,t);this.DrawButtons(r,false,t);this.DrawFloor(r,this.canvasWidth,null,t);this.DrawShooting(r,t);this.DrawPlayer(r,t);this.DrawFight(r,t);n.drawImage(this.backBuffer,0,0)}else{this.MoveLeft=false;this.DrawEndOfLevel(e)}},DrawEndOfLevel:function(e){clearInterval(ATD.MainLoopInterval);ATD.MainLoopInterval=null;var t=this.GameObjManager;t.Group="eol";var n=this.context;var r=this.backBufferContext;this.DestroyCanvas(n,r,true);this.DrawBackground(r,t);this.DrawFloor(r,this.canvasWidth,null,t);this.DrawPlayer(r,t);this.DrawEol(n,r,true);this.DrawHeader(r,this.canvasWidth,t);this.DrawButtons(r,false,t);this.SetDefaults();n.drawImage(this.backBuffer,0,0)}})